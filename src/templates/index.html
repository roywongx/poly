<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyMarket Arb Bot Dashboard</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #16a34a;
            --danger-color: #dc2626;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-main); }
        .container { max-width: 1400px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 2px solid var(--border-color); margin-bottom: 20px;}
        h1 { margin: 0; color: var(--text-main); font-size: 1.8rem; }
        .status-badge { padding: 6px 14px; border-radius: 20px; font-weight: 600; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 0.5px; }
        .status-running { background-color: #dcfce7; color: var(--success-color); border: 1px solid #bbf7d0; }
        .status-stopped { background-color: #fee2e2; color: var(--danger-color); border: 1px solid #fecaca; }
        
        .controls button { padding: 10px 24px; font-size: 15px; font-weight: 600; cursor: pointer; border: none; border-radius: 6px; margin-left: 12px; transition: opacity 0.2s, transform 0.1s; }
        .controls button:active { transform: scale(0.98); }
        .btn-start { background-color: var(--success-color); color: white; box-shadow: 0 4px 6px -1px rgba(22, 163, 74, 0.2); }
        .btn-start:hover { opacity: 0.9; }
        .btn-stop { background-color: var(--danger-color); color: white; box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2); }
        .btn-stop:hover { opacity: 0.9; }

        .layout-grid { display: grid; grid-template-columns: 350px 1fr; gap: 24px; }
        .right-column { display: flex; flex-direction: column; gap: 24px; }
        .grid-half { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }

        .card { background: var(--card-bg); padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .card h2 { margin-top: 0; border-bottom: 2px solid var(--bg-color); padding-bottom: 12px; margin-bottom: 20px; font-size: 1.25rem; color: var(--text-main); display: flex; justify-content: space-between; align-items: center;}
        
        /* Table Styles */
        .table-container { overflow-x: auto; max-height: 250px; overflow-y: auto;}
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: var(--bg-color); font-weight: 600; color: var(--text-muted); position: sticky; top: 0;}
        tbody tr:hover { background-color: var(--bg-color); }

        /* Log Styles */
        .log-container { background: #0f172a; color: #34d399; padding: 16px; border-radius: 8px; height: 350px; overflow-y: auto; font-family: 'Consolas', 'Monaco', monospace; white-space: pre-wrap; font-size: 13px; line-height: 1.5; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
        
        /* Form Styles */
        .config-group { margin-bottom: 16px; }
        .config-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; color: var(--text-main); }
        .config-group input[type="text"], .config-group input[type="number"] { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; box-sizing: border-box; transition: border-color 0.2s; }
        .config-group input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .config-group .help-text { display: block; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
        
        .btn-save { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s; }
        .btn-save:hover { background-color: #1d4ed8; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 24px; border-radius: 8px; display: none; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 1000;}

        /* Tag Styles */
        .badge-tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
        .tag-keyword { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .tag-category { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>PolyMarket Arb Bot</h1>
                <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 4px;">Scalpel V7.0 Dashboard</div>
            </div>
            <div style="display: flex; align-items: center;">
                <div id="status-indicator" class="status-badge status-stopped">Checking...</div>
                <div class="controls">
                    <button class="btn-start" onclick="controlBot('start')">Start Bot</button>
                    <button class="btn-stop" onclick="controlBot('stop')">Stop Bot</button>
                </div>
            </div>
        </div>

        <div class="layout-grid">
            <!-- Left Column: Config -->
            <div class="card">
                <h2>Configuration <button class="btn-save" onclick="saveAllConfig()">Save All</button></h2>
                <div id="config-form">
                    <div class="config-group">
                        <label>ORDER_AMOUNT_USD</label>
                        <input type="number" id="cfg-ORDER_AMOUNT_USD" step="1">
                        <span class="help-text">Size of each bet in USDC (1-5% of bankroll)</span>
                    </div>
                    <div class="config-group">
                        <label>GLOBAL_MAX_POSITIONS</label>
                        <input type="number" id="cfg-GLOBAL_MAX_POSITIONS" step="1">
                        <span class="help-text">Max concurrent trades overall</span>
                    </div>
                    <div class="config-group">
                        <label>MAX_ACTIVE_POSITIONS_PER_CATEGORY</label>
                        <input type="number" id="cfg-MAX_ACTIVE_POSITIONS_PER_CATEGORY" step="1">
                        <span class="help-text">Max trades per topic</span>
                    </div>
                    <div class="config-group">
                        <label>ENTRY_PRICE_MIN</label>
                        <input type="number" id="cfg-ENTRY_PRICE_MIN" step="0.01">
                        <span class="help-text">Minimum win probability (e.g., 0.94)</span>
                    </div>
                    <div class="config-group">
                        <label>MAX_HOURS_TO_EXPIRY</label>
                        <input type="number" id="cfg-MAX_HOURS_TO_EXPIRY" step="0.5">
                        <span class="help-text">Max hours until market resolves</span>
                    </div>
                    <div class="config-group">
                        <label>POISON_KEYWORDS</label>
                        <input type="text" id="cfg-POISON_KEYWORDS" oninput="renderTags()">
                        <span class="help-text">Comma-separated words to avoid</span>
                    </div>
                    <div class="config-group">
                        <label>EXCLUDED_CATEGORIES</label>
                        <input type="text" id="cfg-EXCLUDED_CATEGORIES" oninput="renderTags()">
                        <span class="help-text">Comma-separated categories to skip (e.g., Sports,Pop Culture)</span>
                    </div>
                </div>

                <div style="margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                    <h3 style="font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Active Safety Protection</h3>
                    <div id="active-keywords-tags" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;"></div>
                    <div id="active-categories-tags" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                </div>
            </div>

            <!-- Right Column: Monitoring -->
            <div class="right-column">
                <div class="grid-half">
                    <div class="card">
                        <h2>Active Positions</h2>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Token ID</th>
                                        <th>Entry Price</th>
                                        <th>L2 Timer</th>
                                    </tr>
                                </thead>
                                <tbody id="positions-body">
                                    <tr><td colspan="3" style="text-align: center;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h2>Active Entry Orders</h2>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Market</th>
                                        <th>Token ID</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-body">
                                    <tr><td colspan="3" style="text-align: center;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Live Logs</h2>
                    <div id="log-container" class="log-container">Loading logs...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Settings Saved! Please restart bot to apply.</div>

    <script>
        const CONFIG_KEYS = [
            "ORDER_AMOUNT_USD", "GLOBAL_MAX_POSITIONS", "MAX_ACTIVE_POSITIONS_PER_CATEGORY",
            "ENTRY_PRICE_MIN", "MAX_HOURS_TO_EXPIRY", "POISON_KEYWORDS", "EXCLUDED_CATEGORIES"
        ];

        async function fetchConfig() {
            try {
                const res = await fetch('/api/config');
                const data = await res.json();
                CONFIG_KEYS.forEach(key => {
                    const el = document.getElementById(`cfg-${key}`);
                    if(el && data[key] !== undefined) {
                        el.value = data[key];
                    }
                });
                renderTags();
            } catch (e) {
                console.error("Failed to load config", e);
            }
        }

        function renderTags() {
            const kwInput = document.getElementById('cfg-POISON_KEYWORDS').value;
            const catInput = document.getElementById('cfg-EXCLUDED_CATEGORIES').value;
            
            const kwContainer = document.getElementById('active-keywords-tags');
            const catContainer = document.getElementById('active-categories-tags');
            
            kwContainer.innerHTML = kwInput.split(',').filter(t => t.trim()).map(t => `<span class="badge-tag tag-keyword">${t.trim()}</span>`).join('');
            catContainer.innerHTML = catInput.split(',').filter(t => t.trim()).map(t => `<span class="badge-tag tag-category">${t.trim()}</span>`).join('');
        }

        async function saveAllConfig() {
            try {
                for (const key of CONFIG_KEYS) {
                    const el = document.getElementById(`cfg-${key}`);
                    if(el) {
                        await fetch('/api/config', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({key: key, value: el.value})
                        });
                    }
                }
                showToast("Configuration Saved! Restart bot to apply changes.");
            } catch (e) {
                alert("Failed to save configuration.");
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update Status
                const statusIndicator = document.getElementById('status-indicator');
                if (data.status === 'running') {
                    statusIndicator.textContent = 'RUNNING';
                    statusIndicator.className = 'status-badge status-running';
                } else {
                    statusIndicator.textContent = 'STOPPED';
                    statusIndicator.className = 'status-badge status-stopped';
                }

                // Update Logs
                const logContainer = document.getElementById('log-container');
                if (data.logs && data.logs.length > 0) {
                    const rawLogs = data.logs.join('');
                    if (logContainer.getAttribute('data-raw') !== rawLogs) {
                        logContainer.setAttribute('data-raw', rawLogs);
                        
                        // Parse colors
                        const formattedLogs = data.logs.map(line => {
                            let colorLine = line
                                .replace(/</g, "&lt;").replace(/>/g, "&gt;") // escape HTML
                                .replace(/\| INFO\s+\|/g, '<span style="color: #60a5fa">| INFO     |</span>')
                                .replace(/\| DEBUG\s+\|/g, '<span style="color: #9ca3af">| DEBUG    |</span>')
                                .replace(/\| SUCCESS\s+\|/g, '<span style="color: #34d399; font-weight:bold">| SUCCESS  |</span>')
                                .replace(/\| WARNING\s+\|/g, '<span style="color: #fbbf24">| WARNING  |</span>')
                                .replace(/\| ERROR\s+\|/g, '<span style="color: #ef4444; font-weight:bold">| ERROR    |</span>')
                                .replace(/\| CRITICAL\s+\|/g, '<span style="color: #b91c1c; font-weight:bold; background: #fee2e2">| CRITICAL |</span>');
                            
                            // Highlight keywords in lines
                            if (colorLine.includes('[FILTERED]')) {
                                colorLine = colorLine.replace('[FILTERED]', '<span style="color: #9ca3af">[FILTERED]</span>');
                            }
                            if (colorLine.includes('TARGET ACQUIRED')) {
                                colorLine = `<span style="color: #34d399">${colorLine}</span>`;
                            }
                            return colorLine;
                        }).join('');

                        logContainer.innerHTML = formattedLogs;
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                } else {
                    logContainer.innerHTML = "No logs available. Start the bot to see output.";
                }

                // Update State (Positions)
                if (data.state) {
                    const posBody = document.getElementById('positions-body');
                    if (data.state.active_positions && Object.keys(data.state.active_positions).length > 0) {
                        posBody.innerHTML = Object.entries(data.state.active_positions).map(([tokenId, pos]) => `
                            <tr>
                                <td title="${tokenId}">${tokenId.substring(0, 8)}...</td>
                                <td><span style="color:var(--success-color); font-weight:bold;">${pos.entry_price}</span></td>
                                <td>${pos.l2_trigger_time ? `<span style="color:var(--danger-color)">${new Date(pos.l2_trigger_time * 1000).toLocaleTimeString()}</span>` : '-'}</td>
                            </tr>
                        `).join('');
                    } else {
                        posBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No active positions</td></tr>';
                    }

                    const ordBody = document.getElementById('orders-body');
                    if (data.state.active_entry_orders && Object.keys(data.state.active_entry_orders).length > 0) {
                        ordBody.innerHTML = Object.entries(data.state.active_entry_orders).map(([orderId, ord]) => `
                            <tr>
                                <td title="${orderId}">${orderId.substring(0, 8)}...</td>
                                <td title="${ord.market_name}">${(ord.market_name || '').substring(0, 25)}...</td>
                                <td title="${ord.token_id}">${ord.token_id.substring(0, 8)}...</td>
                            </tr>
                        `).join('');
                    } else {
                        ordBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No active entry orders</td></tr>';
                    }
                }

            } catch (error) {
                console.error("Error fetching status:", error);
                document.getElementById('status-indicator').textContent = 'API OFFLINE';
                document.getElementById('status-indicator').className = 'status-badge status-stopped';
            }
        }

        async function controlBot(action) {
            try {
                await fetch(`/api/bot/${action}`, { method: 'POST' });
                if(action === 'start') {
                    showToast("Bot starting...");
                } else {
                    showToast("Bot stopping...");
                }
                setTimeout(fetchStatus, 1000); 
            } catch (error) {
                alert(`Failed to ${action} bot. Check console.`);
            }
        }

        // Initialize
        fetchConfig();
        fetchStatus();
        setInterval(fetchStatus, 3000); // Poll status
    </script>
</body>
</html>